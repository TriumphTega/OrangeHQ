From 387ddbb53d4ff2a64ea87689cc320bec32c0ac3e Mon Sep 17 00:00:00 2001
From: a <a>
Date: Thu, 9 Jan 2025 04:05:16 +0530
Subject: [PATCH] Implement per page charges

---
 Hub/Hub2.0.html        |   3 +
 app/Netty/Netty.html   |   3 +
 app/Netty/Netty01.html |   8 +--
 app/Netty/Netty02.html |   7 +-
 app/Netty/Netty03.html |   9 +--
 app/Netty/Netty04.html |   8 +--
 app/Netty/Netty05.html |   7 +-
 app/RW/RW01.html       |   3 +
 app/RW/RW02.html       |   4 +-
 app/RW/RW03.html       |   3 +
 app/RW/RW04.html       |   3 +
 app/RW/RW05.html       |   3 +
 app/RW/RWprologue.html |   5 +-
 js/index.js            | 148 +++++++++++++++++++++++++++++++++++++++++
 14 files changed, 194 insertions(+), 20 deletions(-)
 create mode 100644 js/index.js

diff --git a/Hub/Hub2.0.html b/Hub/Hub2.0.html
index 2414a98..554dbda 100644
--- a/Hub/Hub2.0.html
+++ b/Hub/Hub2.0.html
@@ -13,6 +13,9 @@
 
 <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
 
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 
 <body>
diff --git a/app/Netty/Netty.html b/app/Netty/Netty.html
index 92dd272..07f9b1e 100644
--- a/app/Netty/Netty.html
+++ b/app/Netty/Netty.html
@@ -23,6 +23,9 @@
 
   <title>Netty</title>
   
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 <body>
 
diff --git a/app/Netty/Netty01.html b/app/Netty/Netty01.html
index 1ad8c8d..dae874b 100644
--- a/app/Netty/Netty01.html
+++ b/app/Netty/Netty01.html
@@ -10,10 +10,10 @@
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
     
-    <!DOCTYPE html>
-<html lang="en">
-
-<head>
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
+</head>
 
     <title>Rising Water Chapter 3</title>
     <link rel=stylesheet href="../Netty/pages.css">
diff --git a/app/Netty/Netty02.html b/app/Netty/Netty02.html
index d43eb63..da4edec 100644
--- a/app/Netty/Netty02.html
+++ b/app/Netty/Netty02.html
@@ -10,10 +10,11 @@
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
     
-    <!DOCTYPE html>
-<html lang="en">
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
+</head>
 
-<head>
 
     <title>Rising Water Chapter 3</title>
     <link rel=stylesheet href="../Netty/pages.css">
diff --git a/app/Netty/Netty03.html b/app/Netty/Netty03.html
index a599e05..5d70442 100644
--- a/app/Netty/Netty03.html
+++ b/app/Netty/Netty03.html
@@ -9,10 +9,11 @@
     <meta http-equiv="X-UA-Compatible" content="IE-edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
-    <!DOCTYPE html>
-<html lang="en">
-    <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
-<head>
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
+</head>
+
 
     <title>Rising Water Chapter 3</title>
     <link rel=stylesheet href="../Netty/pages.css">
diff --git a/app/Netty/Netty04.html b/app/Netty/Netty04.html
index 823aab2..5735fe3 100644
--- a/app/Netty/Netty04.html
+++ b/app/Netty/Netty04.html
@@ -9,10 +9,10 @@
     <meta http-equiv="X-UA-Compatible" content="IE-edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
-    <!DOCTYPE html>
-<html lang="en">
-
-<head>
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
+</head>
 
     <title>Rising Water Chapter 3</title>
     <link rel=stylesheet href="../Netty/pages.css">
diff --git a/app/Netty/Netty05.html b/app/Netty/Netty05.html
index 5f8dbdd..25a335d 100644
--- a/app/Netty/Netty05.html
+++ b/app/Netty/Netty05.html
@@ -9,10 +9,11 @@
     <meta http-equiv="X-UA-Compatible" content="IE-edge">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
-    <!DOCTYPE html>
-<html lang="en">
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
+</head>
 
-<head>
 
     <title>Rising Water Chapter 3</title>
     <link rel=stylesheet href="../Netty/pages.css">
diff --git a/app/RW/RW01.html b/app/RW/RW01.html
index 7c7aa86..1a371bf 100644
--- a/app/RW/RW01.html
+++ b/app/RW/RW01.html
@@ -25,6 +25,9 @@
           </header>
 
       
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 
 <body>
diff --git a/app/RW/RW02.html b/app/RW/RW02.html
index 9d65982..bbfbf9b 100644
--- a/app/RW/RW02.html
+++ b/app/RW/RW02.html
@@ -23,7 +23,9 @@
               </div>
           </header>
     
-      
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 
 <body>
diff --git a/app/RW/RW03.html b/app/RW/RW03.html
index 50a669c..cda3aac 100644
--- a/app/RW/RW03.html
+++ b/app/RW/RW03.html
@@ -26,6 +26,9 @@
               </div>
           </header>
       
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 
 <body>
diff --git a/app/RW/RW04.html b/app/RW/RW04.html
index 8f3b293..f73e611 100644
--- a/app/RW/RW04.html
+++ b/app/RW/RW04.html
@@ -26,6 +26,9 @@
               </div>
           </header>
       
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 <body>
 
diff --git a/app/RW/RW05.html b/app/RW/RW05.html
index d7f6bd1..53a17bd 100644
--- a/app/RW/RW05.html
+++ b/app/RW/RW05.html
@@ -26,6 +26,9 @@
               </div>
           </header>
       
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
 </head>
 <body>
 
diff --git a/app/RW/RWprologue.html b/app/RW/RWprologue.html
index e402d84..5fc60f9 100644
--- a/app/RW/RWprologue.html
+++ b/app/RW/RWprologue.html
@@ -10,7 +10,10 @@
     <link rel="stylesheet" href="../assets/fontawesome-free-6.5.1-web/css/all.css">
     <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
     <script src="https://kit.fontawesome.com/3c57be3453.js" crossorigin="anonymous"></script>
-  </head>
+    <script src="https://bundle.run/buffer@6.0.3" defer=""></script>
+    <script src="https://unpkg.com/@solana/web3.js@1.98.0/lib/index.iife.js" defer=""></script>
+    <script src="/js/index.js" defer=""></script>
+</head>
     
 <body>
     
diff --git a/js/index.js b/js/index.js
new file mode 100644
index 0000000..fe777e4
--- /dev/null
+++ b/js/index.js
@@ -0,0 +1,148 @@
+let wallet;
+let walletButton;
+
+if (typeof window.buffer != "undefined") {
+  window.Buffer = buffer.Buffer;
+}
+
+window.addEventListener("load", () => {
+  connectWallet(true);
+
+  walletButton = document.querySelector("button:has(.fa-wallet)");
+  walletButton.addEventListener("click", connectWallet);
+
+  if (!window.location.pathname.startsWith("/Hub")) {
+    connectWallet();
+  }
+
+  chargeUserForPage();
+});
+
+async function connectWallet(autoconnect = false) {
+  if (wallet) return;
+  let connectPromise = window.solana
+    .connect({ onlyIfTrusted: autoconnect })
+    .then(() => setWallet(window.solana));
+  if (autoconnect)
+    connectPromise.catch((e) =>
+      console.error(`autoconnect failed: ${e?.message}`),
+    );
+  return connectPromise;
+}
+
+function setWallet(newWallet) {
+  wallet = newWallet;
+
+  const publicKey = wallet.publicKey.toString();
+
+  let walletAddress = document.querySelector("#wallet-address");
+  if (!walletAddress) {
+    walletAddress = document.createElement("span");
+    walletAddress.id = "wallet-address";
+    walletButton.parentElement.appendChild(walletAddress);
+  }
+
+  walletAddress.textContent =
+    publicKey.substring(0, 4) +
+    "..." +
+    publicKey.substring(publicKey.length - 4);
+}
+
+async function getWallet() {
+  if (!wallet) await connectWallet();
+  return wallet;
+}
+
+const DEFAULT_CHARGE = { sol: 0.001, tokens: 100 };
+function createCharge(address, { sol, tokens } = DEFAULT_CHARGE) {
+  return {
+    address,
+    sol,
+    tokens,
+  };
+}
+
+const CHARGE_TABLE = {
+  "/app/Netty/Netty01.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/Netty/Netty02.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/Netty/Netty03.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/Netty/Netty04.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/Netty/Netty05.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+
+  "/app/RW/RW01.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/RW/RW02.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/RW/RW03.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/RW/RW04.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+  "/app/RW/RW05.html": createCharge(
+    "3FVrkePokrBYhQKthGjpTr8MCsPAymTStHuPCsLZ6SLX",
+  ),
+};
+
+async function chargeUserForPage() {
+  let store = {};
+  try {
+    store = JSON.parse(sessionStorage.chargeTable);
+  } catch (e) {
+    console.error(
+      `could not read charge table from session storage: ${e?.message}`,
+    );
+  }
+
+  const page = window.location.pathname;
+  const charge = CHARGE_TABLE[page];
+  if (!charge || page in store) return true;
+  const element = document.querySelector(".Body") ?? document.body;
+  const elementTextColor = element.style.color;
+  element.style.color = "transparent";
+
+  const {
+    Connection,
+    PublicKey,
+    SystemProgram,
+    Transaction,
+    LAMPORTS_PER_SOL,
+  } = solanaWeb3;
+
+  const wallet = await getWallet();
+  const connection = new Connection("https://api.devnet.solana.com");
+
+  const tx = new Transaction().add(
+    SystemProgram.transfer({
+      fromPubkey: wallet.publicKey,
+      toPubkey: new PublicKey(charge.address),
+      lamports: Math.floor(charge.sol * LAMPORTS_PER_SOL),
+    }),
+  );
+  tx.feePayer = wallet.publicKey;
+  tx.recentBlockhash = await connection
+    .getLatestBlockhash()
+    .then(({ blockhash }) => blockhash);
+
+  return wallet.signAndSendTransaction(tx).then((signature) => {
+    store[page] = {
+      signature,
+      charge,
+    };
+    sessionStorage.chargeTable = JSON.stringify(store);
+	element.style.color = elementTextColor;
+    return signature;
+  });
+}
-- 
2.47.1.windows.1

